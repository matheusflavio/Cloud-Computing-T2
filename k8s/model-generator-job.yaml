# Job para executar o container ML que gera o modelo
# Comentário: este job roda uma vez e termina, ideal para geração do modelo
apiVersion: batch/v1
kind: Job
metadata:
  name: recommender-model-generator
  labels:
    app: recommender-model  # label para identificar o job
spec:
  template:
    metadata:
      labels:
        app: recommender-model
    spec:
      restartPolicy: OnFailure  # não reinicia se completar com sucesso
      initContainers:
      - name: download-dataset
        image: curlimages/curl:latest
        command:
        - sh
        - -c
        - |
          curl -L -o /data/2023_spotify_ds1.csv "https://github.com/matheusflavio/Cloud-Computing-T2/raw/main/datasets/2023_spotify_ds1.csv"
        volumeMounts:
        - name: dataset-volume
          mountPath: /data
      containers:
      - name: model-generator
        image: soramf/playlist-generator:0.2  # imagem do gerador (versão 0.1)
        imagePullPolicy: IfNotPresent
        volumeMounts:
        - name: model-volume
          mountPath: /output  # onde o modelo será salvo
        - name: dataset-volume
          mountPath: /data    # onde o dataset será montado
        env:
        - name: OUTPUT_PATH
          value: /output/recommendation_model.pickle
        - name: DATA_PATH
          value: /data/2023_spotify_ds1.csv
      volumes:
      - name: model-volume
        persistentVolumeClaim:
          claimName: recommender-pvc  # mesmo nome do PVC
      - name: dataset-volume
        emptyDir: {}  # Volume temporário para o dataset (compartilhado entre init container e container principal)